/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model for the KonimPay application,
 * with a special exception for an administrator role.
 *
 * Administrator Access: A specific user, identified by their email address, is granted
 * full read/write access to all data for administrative purposes.
 *
 * Standard User Access: All other users operate under a user-ownership model.
 * Each user ("Publisher") can only access and manage data explicitly associated with their own user ID.
 *
 * Data Structure: The data is primarily organized under a top-level `/publishers` collection.
 * Each publisher's data, including their `offers` and `payments`, is nested within their
 * specific document path (e.g., /publishers/{publisherId}/...).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user is the designated administrator.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.email == 'faubriciosanchez1@gmail.com';
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update/delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that a new subcollection document correctly links back to its parent publisher.
     */
    function hasValidPublisherRelationOnCreate(publisherId) {
      return request.resource.data.publisherId == publisherId;
    }

    /**
     * Ensures the link to the parent publisher cannot be changed after creation.
     */
    function isPublisherRelationImmutable() {
      return request.resource.data.publisherId == resource.data.publisherId;
    }

    /**
     * @description Manages publisher profiles. Admin has full access. Users can manage only their own profile.
     * @path /publishers/{publisherId}
     * @allow Admin can do anything. A user can create their own profile, and read/update/delete it.
     * @deny An authenticated user tries to get another user's profile. Listing all publishers is forbidden for non-admins.
     */
    match /publishers/{publisherId} {
      allow read, write: if isAdmin();
      allow get: if isOwner(publisherId);
      allow list: if false; // List is covered by admin rule above.
      allow create: if isOwner(publisherId) && request.resource.data.id == publisherId;
      allow update: if isExistingOwner(publisherId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(publisherId);
    }

    /**
     * @description Manages offers for a specific publisher. Admin has full access. Access is tied to the parent publisher for others.
     * @path /publishers/{publisherId}/offers/{offerId}
     * @allow Admin can do anything. A user can manage offers under their own publisher ID.
     * @deny A user tries to access offers belonging to a different publisher.
     */
    match /publishers/{publisherId}/offers/{offerId} {
      allow read, write: if isAdmin();
      allow get: if isOwner(publisherId);
      allow list: if isOwner(publisherId);
      allow create: if isOwner(publisherId) && hasValidPublisherRelationOnCreate(publisherId);
      allow update: if isExistingOwner(publisherId) && isPublisherRelationImmutable();
      allow delete: if isExistingOwner(publisherId);
    }
    
    /**
     * @description Manages the global catalog of offers. Only admins can manage this collection.
     * @path /global-offers/{offerId}
     * @allow Admin can read and write.
     * @deny Any non-admin user attempting any operation.
     */
    match /global-offers/{offerId} {
      allow read, write: if isAdmin();
    }


    /**
     * @description Manages payments for a specific publisher. Admin has full access. Access is tied to the parent publisher for others.
     * @path /publishers/{publisherId}/payments/{paymentId}
     * @allow Admin can do anything. A user can manage payments associated with their publisher ID.
     * @deny A user tries to update a payment document for another publisher.
     */
    match /publishers/{publisherId}/payments/{paymentId} {
      allow read, write: if isAdmin();
      allow get: if isOwner(publisherId);
      allow list: if isOwner(publisherId);
      allow create: if isOwner(publisherId) && hasValidPublisherRelationOnCreate(publisherId);
      allow update: if isExistingOwner(publisherId) && isPublisherRelationImmutable();
      allow delete: if isExistingOwner(publisherId);
    }

    /**
     * @description Manages payment receipts. Admin has full access. Currently locked for others.
     * @path /receipts/{receiptId}
     * @allow Admin can do anything.
     * @deny Any non-admin user attempting any operation.
     * @principle Failsafe lockdown due to missing ownership data in the document schema for non-admins.
     */
    match /receipts/{receiptId} {
      allow read, write: if isAdmin();
      // CRITICAL: Cannot implement secure rules for non-admin users. The 'Receipt'
      // entity is missing a 'publisherId' field to associate it with an owner.
      // To fix this, add a `publisherId` field to every receipt document.
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
